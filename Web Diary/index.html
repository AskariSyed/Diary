<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>E-Diary App</title>
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <link rel="stylesheet" href="diary.css">

  <style>
    .weekday-header{
      text-align: center;
      font-weight: bold;
      padding: 5px 0;
      color: #666;
      font-size: 0.85em;
    }
    .diary-card {
      position: fixed;
      top: 60px;
      left: 350px;
      width: calc(100% - 370px);
      height: 85vh;
      overflow-y: auto;
      background: #fff;
      padding: 20px;
      box-shadow: -1px 0 5px rgba(0, 0, 0, 0.1);
      z-index: 10;
    }
    .kanban-board {
      display: flex;
      justify-content: space-between;
      overflow-x: auto;
      margin-top: 20px;
    }
    .kanban-columns {
      display: flex;
      width: 100%;
      gap: 10px;
    }
    .kanban-column {
      flex: 0 0 calc(100% / 6 - 10px);
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 0;
      min-width: 160px;
    }
    .kanban-header {
      font-weight: bold;
      padding: 10px;
      border-bottom: 1px solid #ccc;
      text-align: center;
      border-radius: 8px 8px 0 0;
    }
    .kanban-content {
      padding: 10px;
      min-height: 465px;
    }
    .task-card {
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
      font-size: 14px;
    }

    /* Calendar Styles */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: center;
      cursor: pointer;
    }
    .empty-day{
      visibility: hidden;
    }
    .sidebar {
  position: fixed;
  top: 80px;
  left: 20px;
  width: 320px;
  height: calc(100vh - 15vh);
  overflow-y: auto;
  background: #f8f9fa;
  padding: 15px;
  box-shadow: 1px 0 5px rgba(0, 0, 0, 0.1);
  z-index: 5;
  /* Rounded corners */
  border-top-right-radius: 20px;  /* Top right curve */
  border-bottom-right-radius: 20px;  /* Bottom right curve */
  /* Smooth transition */
  transition: border-radius 0.3s ease;
}
  </style>
</head>
<body>
  <div id="app">
    <div class="diary-card" data-page-id="1">
      <div class="diary-card-content">
        <div class="task-input-section">
          <div class="add-task-container">
            <input type="text" class="diary-task-input spellcheck-input" placeholder="Enter your task..." />
            <button class="add-task-btn" onclick="if(this.previousElementSibling.value.trim() === '') { alert('Please add a task first'); return; } addNewTask(this);">
              Add Task
            </button>
             
            <button class="btn btn-outline-primary voice-btn" type="button" title="Speak Task">
              <i class="fas fa-microphone"></i>
            </button>
           <button id="export-pdf-btn" class="add-task-btn" title="Export PDF">
  <i class="fas fa-file-pdf"></i>
</button>

            <span class="voice-status" style="display:none;"></span>
            <button class="btn btn-outline-success" id="openImportModalBtn" title="Import Tasks from Date">
              <i class="fas fa-file-import"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="kanban-board">
        <div class="kanban-columns">
          <div class="kanban-column"><div class="kanban-header">To-Do</div><div class="kanban-content" id="todo-column"></div></div>
          <div class="kanban-column"><div class="kanban-header">In Progress</div><div class="kanban-content" id="inprogress-column"></div></div>
          <div class="kanban-column"><div class="kanban-header">To Discuss</div><div class="kanban-content" id="todiscuss-column"></div></div>
          <div class="kanban-column"><div class="kanban-header">Follow-Up</div><div class="kanban-content" id="followup-column"></div></div>
          <div class="kanban-column"><div class="kanban-header">On Hold</div><div class="kanban-content" id="onhold-column"></div></div>
          <div class="kanban-column"><div class="kanban-header">Completed</div><div class="kanban-content" id="completed-column"></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚úÖ Modal -->
  <div class="modal fade" id="importModal" tabindex="-1" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title">üìÖ Select Date to Import Tasks</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="date" id="importDate" class="form-control" />
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="confirmImportBtn">Import</button>
        </div>
      </div>
    </div>
  </div>

  <!-- navbar -->
  <div class="custom-navbar-wrapper">
    <!-- Left section (green) -->
    <div class="custom-navbar-left">
     <a href="#" id="ediary-logo-link" style="display: inline-flex; align-items: center; text-decoration: none; font-size: 24px; color: white;">
        <img src="https://upload.wikimedia.org/wikipedia/en/thumb/4/44/PakTelecom.png/375px-PakTelecom.png" alt="PTA Logo" style="height: 38px; width: 45px; border-radius: 10%; margin-right: 8px;">
        e-Diary
      </a>
    </div>
  
  <!-- Right section (white) -->
<div class="custom-navbar-right" 
     style="display: flex; align-items: center; justify-content: flex-end; flex-grow: 1;">

  <!-- Date Title -->
  <span id="diary-date-title" 
        style="margin-right: auto; color: black; font-size: 1.1rem;">
  </span>

  <!-- Notes Button + Search Bar -->
  <div class="position-relative" style="margin-left: 20px; display: flex; align-items: center; gap: 10px;">
    
    <!-- Notes Button -->
    <button id="notes-btn" class="add-task-btn" title="Notes">
  <i class="fas fa-sticky-note"></i>
</button>

    <!-- Search Bar -->
    <div class="position-relative">
      <input type="text" 
             class="form-control search-bar" 
             id="global-search"
             placeholder="üîç Search for Task here..."
             style="font-size: 0.95rem; width: 200px; height: 36px; 
                    padding: 4px 10px; border-radius: 6px; 
                    box-shadow: 0 1px 4px rgba(0,0,0,0.04);">

      <!-- Search Results Dropdown -->
      <div id="search-results"
           style="position: absolute; top: 100%; right: 0; z-index: 999; 
                  max-height: 300px; overflow-y: auto; width: 200px; 
                  background: white; border: 1px solid #ddd; border-radius: 6px; 
                  box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none;">
      </div>
    </div>
  </div>
</div>
<div id="notes-modal" 
     style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
            background:white; padding:20px; border-radius:8px; width:300px; 
            box-shadow:0 4px 10px rgba(0,0,0,0.2); z-index:1000;">
  <h3>üìù Diary Note</h3>
  <textarea id="note-content" 
            style="width:100%; height:120px; margin-top:10px; padding:8px; border-radius:6px; border:1px solid #ccc;"></textarea>
  <div style="margin-top:12px; text-align:right;">
    <button id="save-note" style="background:#28a745; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">üíæ Save</button>
    <button id="close-note" style="background:#dc3545; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer;">‚úñ Close</button>
  </div>
</div>

  <!-- ‚úÖ Calendar Section -->
  <div class="sidebar">
    <div class="calendar-bar mb-3">
     

      <div class="calendar-container mt-3" style="color: #333;">
        <div class="calendar-header d-flex justify-content-between align-items-center">
          <button onclick="prevMonth()" style="color: #333;">‚Üê</button>
          <h6 id="calendarMonthYear" style="color: #333;">Month Year</h6>
          <button onclick="nextMonth()" style="color: #333;">‚Üí</button>
        </div>
        <div class="calendar-grid" id="calendarGrid" style="color: #333;"></div>
      </div>
    </div>

    <!-- Navigation Links in Two Columns -->
    <div class="nav-links-grid mt-3">
      <div class="nav-links-column">
        <a class="nav-link" href="#" onclick="showAllTasks()"><i class="fas fa-chart-bar"></i>All Tasks</a>
        <a class="nav-link" href="#" onclick="showInProgressTasks()"><i class="fas fa-envelope"></i>In Progress</a>
        <a class="nav-link" href="#" onclick="showNeedToDiscussTasks()"><i class="fas fa-question-circle"></i>Need To Discuss</a>
      </div>
      <div class="nav-links-column">
        <a class="nav-link" href="#" onclick="showDoneTasks()"><i class="fas fa-calendar-check"></i>Completed</a>
        <a class="nav-link" href="#" onclick="showFollowUpTasks()"><i class="fas fa-cog"></i>Follow Up</a>
        <a class="nav-link" href="#" onclick="showOnHoldTasks()"><i class="fas fa-pause"></i>On Hold</a>
      </div>
    </div>

    <!-- Calendar Navigation -->
    <div class="page-navigation mt-3">
      <button id="prevPageBtn">‚Üê Previous</button>
      <button id="nextPageBtn">Next ‚Üí</button>
    </div>

    <button class="go-to-today-btn w-90 mt-3" onclick="goToToday()">
      <i class="fa fa-calendar-day"></i> Go to Today
    </button>
  </div>

  <div id="filtered-tasks-container" class="mb-4" style="display: none;">
    <div class="card" style="background: #fff; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 24px; max-width: 800px; margin: 0 auto;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 id="filtered-tasks-title" style="margin: 0; color: #2563eb; font-weight: 600;"></h4>
        <button class="btn btn-outline-secondary btn-sm" onclick="hideFilteredTasks()">
          <i class="fas fa-times"></i> Close
        </button>
      </div>
      <div id="filtered-tasks-list" style="max-height: 400px; overflow-y: auto;"></div>
    </div>
    <!-- Task History Modal -->
<div class="modal fade" id="taskHistoryModal" tabindex="-1" aria-labelledby="taskHistoryLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="taskHistoryLabel">Task History</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="taskHistoryContent">
        <!-- Content will be injected by JS -->
      </div>
    </div>
  </div>
</div>


   <!-- ‚úÖ Bootstrap JS for modal support -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API_BASE_URL = 'http://192.168.137.1:5158';
// const API_BASE_URL = 'https://584af84ba1d3.ngrok-free.app';

let draggedTask = null;

// Format Date to YYYY-MM-DD
function formatDateAsYMD(date) {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// Normalize any incoming date-ish string to YYYY-MM-DD (robust)
function normalizeDateISO(dateStr) {
  if (!dateStr) return '';
  if (/^\d{4}-\d{1,2}-\d{1,2}$/.test(dateStr)) {
    const parts = dateStr.split('-');
    return `${parts[0]}-${String(parts[1]).padStart(2,'0')}-${String(parts[2]).padStart(2,'0')}`;
  }
  const left = (dateStr.split('T')[0] || dateStr);
  const p = left.split('-');
  if (p.length === 3 && p[0].length === 4) return `${p[0]}-${String(p[1]).padStart(2,'0')}-${String(p[2]).padStart(2,'0')}`;
  const d = new Date(dateStr);
  if (isNaN(d)) return dateStr;
  return formatDateAsYMD(d);
}

// Update the navbar date display
function updateNavbarDate(dateStr) {
  const normalized = normalizeDateISO(dateStr);
  const [year, month, day] = normalized.split("-");
  const dateObj = new Date(year, month - 1, day);
  const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  const el = document.getElementById("diary-date-title");
  if (el) el.textContent = dateObj.toLocaleDateString('en-US', options);
}

// Calendar rendering (uses local date strings for data-date)
function renderCalendar(date) {
  const calendarGrid = document.getElementById("calendarGrid");
  const monthYearLabel = document.getElementById("calendarMonthYear");

  const year = date.getFullYear();
  const month = date.getMonth();
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();

  calendarGrid.innerHTML = "";
  monthYearLabel.textContent = date.toLocaleString('default', { month: 'long', year: 'numeric' });

  const startingDay = firstDay.getDay();

  for (let i = 0; i < startingDay; i++) {
    const empty = document.createElement("div");
    empty.classList.add("calendar-day");
    calendarGrid.appendChild(empty);
  }

  for (let i = 1; i <= daysInMonth; i++) {
    const dayDiv = document.createElement("div");
    dayDiv.classList.add("calendar-day");
    dayDiv.textContent = i;
    // local YYYY-MM-DD without timezone shifting
    const localDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
    dayDiv.setAttribute("data-date", localDate);
    calendarGrid.appendChild(dayDiv);
  }
}

function prevMonth() {
  currentDate.setMonth(currentDate.getMonth() - 1);
  renderCalendar(currentDate);
}
function nextMonth() {
  currentDate.setMonth(currentDate.getMonth() + 1);
  renderCalendar(currentDate);
}

function sanitizeStatus(status) {
  return status.toLowerCase().replace(/[\s\-]/g, '');
}
function handleDragStart(e) { draggedTask = e.target; }
function handleDragOver(e) { e.preventDefault(); }
function handleDrop(e) {
  e.preventDefault();
  const newColumn = e.currentTarget;
  const newStatus = newColumn.previousElementSibling?.textContent.trim() || '';
  if (!draggedTask) return;
  newColumn.appendChild(draggedTask);
  const taskId = draggedTask.dataset.taskId;
  if (taskId) updateTaskStatus(taskId, newStatus);
}

// ---------- API helpers ----------

// Check whether a page exists for date by fetching diary pages and comparing normalized date
async function checkPageExists(date) {
  try {
    const pages = await getAllDiaryPages();
    const norm = normalizeDateISO(date);
    return pages.some(p => normalizeDateISO(p.pageDate) === norm);
  } catch (err) {
    console.error("Error checking page existence:", err);
    return false;
  }
}

// Create page for given date (send local midnight string)
async function createPageByDate(date) {
  const [y,m,d] = normalizeDateISO(date).split('-');
  const isoDate = `${y}-${m}-${d}T00:00:00`; // local-date midnight (no Z)
  try {
    const res = await fetch(`${API_BASE_URL}/api/Pages/create`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ pageDate: isoDate, diaryNo: 1 })
    });
    if (!res.ok) throw new Error(`Create failed ${res.status}`);
    const data = await res.json();

    
    // ‚úÖ Page create hote hi pageId set karo
    window.currentPageId = data.id;
    // set currentSelectedDate to normalized created date
    currentSelectedDate = normalizeDateISO(date);
    updateNavbarDate(currentSelectedDate);
    await loadTasksForDate(currentSelectedDate);
    console.log("Page created:", data);
    return data;
  } catch (err) {
    console.error("Create page error:", err);
    alert("Failed to create page.");
    return null;
  }
}

// Get all pages for diary 1 (single robust implementation)
async function getAllDiaryPages() {
  try {
    const res = await fetch(`${API_BASE_URL}/api/Pages/by-diary/1`);
    if (!res.ok) {
      console.error('Failed to fetch diary pages:', res.status);
      return [];
    }
    const pages = await res.json();
    return Array.isArray(pages) ? pages : [];
  } catch (err) {
    console.error('Error fetching diary pages:', err);
    return [];
  }
}

// ---------- Tasks CRUD & rendering ----------

function updateTaskStatus(taskId, newStatus) {
  fetch(`${API_BASE_URL}/api/Tasks/pagetask/${taskId}/status`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ status: newStatus })
  })
  .then(res => res.json())
  .then(data => console.log("Task status updated:", data))
  .catch(err => console.error("Update status error:", err));
}

function updateTaskTitle(taskId, newTitle) {
  fetch(`${API_BASE_URL}/api/Tasks/pagetask/${taskId}/title`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title: newTitle })
  })
  .then(res => res.json())
  .then(data => console.log("Title updated:", data))
  .catch(err => console.error("Update title error:", err));
}

function addNewTask(button) {
  const input = button.previousElementSibling;
  const taskContent = input.value.trim();
  if (!taskContent) return alert("Please enter a task.");

  const payload = {
    pageId: window.currentPageId || null, // ensure pageId is set after create/open
    title: taskContent,
    status: "To-Do"
  };

  fetch(`${API_BASE_URL}/api/Tasks/create`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.content || ''
    },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    console.log("Task created:", data);
    input.value = "";
    if (currentSelectedDate) loadTasksForDate(currentSelectedDate);
  })
  .catch(err => {
    console.error("Create task error:", err);
    alert("Failed to create task.");
  });
}

async function loadTasksForDate(date) {
  document.querySelectorAll('.kanban-content').forEach(col => col.innerHTML = '');
  const norm = normalizeDateISO(date);
  try {
    const response = await fetch(`${API_BASE_URL}/api/tasks/search?pageDate=${norm}`);
    if (!response.ok) {
      console.error('tasks fetch failed', response.status);
      return;
    }
    const tasks = await response.json();
    if (tasks.length > 0 && tasks[0].pageId) {
      window.currentPageId = tasks[0].pageId;
    }
    renderTasks(tasks);
    // store current page id if API returns page info (optional)
    // window.currentPageId = ...;
  } catch (err) {
    console.error('Failed to fetch tasks:', err);
  }
}

function renderTasks(tasks) {
  // Adjust mapping if your UI has different container ids; this example uses columns by id
  const map = {
    'todo': 'todo-column',
    'inprogress': 'inprogress-column',
    'todiscuss': 'todiscuss-column',
    'followup': 'followup-column',
    'onhold': 'onhold-column',
    'completed': 'completed-column'
  };

  tasks.forEach(task => {
    if (!task.status) task.status = 'To-Do';
    if (task.status.toLowerCase() === 'deleted') return;

    const status = sanitizeStatus(task.status);
    const columnId = map[status] || 'todo-column';

    const div = document.createElement('div');
    div.className = 'task-card';
    div.setAttribute('draggable', true);
    div.dataset.taskId = task.id;
    div.dataset.originalStatus = task.status;

    div.innerHTML = `
  <span class="task-title">${task.title}</span>
  <button class="task-history-btn" title="View Task History">
    <i class="fas fa-history"></i>
  </button>
  <button class="delete-task-btn" title="Delete Task">
    <i class="fas fa-trash-alt"></i>
  </button>
`;

div.querySelector('.task-history-btn').addEventListener('click', (e) => {
  e.stopPropagation();
  viewTaskHistory(task.parentTaskId || task.id);
});

    div.addEventListener('dragstart', handleDragStart);

    div.querySelector('.task-title').addEventListener('click', () => {
      const newTitle = prompt("Edit Task Title:", task.title);
      if (newTitle && newTitle !== task.title) {
        updateTaskTitle(task.id, newTitle);
        div.querySelector('.task-title').textContent = newTitle;
      }
    });

    div.querySelector('.delete-task-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      if (confirm("Delete this task?")) {
        updateTaskStatus(task.id, "Deleted");
        div.remove();
      }
    });

    const column = document.getElementById(columnId);
    if (column) column.appendChild(div);
  });
}

  function renderFilteredTasks(tasks) {
    const list = document.getElementById('filtered-tasks-list');
    if (!list) return;
  
    tasks.forEach(task => {
      const div = document.createElement('div');
      div.className = 'task-card';
      div.dataset.taskId = task.id;
  
      div.innerHTML = `
        <span class="task-title">${task.title}</span>
        <button class="delete-task-btn" title="Delete Task">
          <i class="fas fa-trash-alt"></i>
        </button>
      `;
  
      div.querySelector('.task-title').addEventListener('click', () => {
        const newTitle = prompt("Edit Task Title:", task.title);
        if (newTitle && newTitle !== task.title) {
          updateTaskTitle(task.id, newTitle);
          div.querySelector('.task-title').textContent = newTitle;
        }
      });
  
      div.querySelector('.delete-task-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        if (confirm("Delete this task?")) {
          updateTaskStatus(task.id, "Deleted");
          div.remove();
        }
      });
  
      list.appendChild(div);
    });
  }


// ---------- Navigation (next/previous pages) ----------

let currentDate = new Date();
let currentSelectedDate = formatDateAsYMD(new Date()); // normalized YYYY-MM-DD by default

// next page
// Go to the next page
async function goToNextPage() {
  try {
    const pages = await getAllDiaryPages();
    const dates = [...new Set(pages.map(p => normalizeDateISO(p.pageDate)))]
      .filter(Boolean)
      .sort((a, b) => new Date(a) - new Date(b));

    console.log('pages (sorted):', dates);

    const cur = normalizeDateISO(currentSelectedDate || formatDateAsYMD(new Date()));
    const idx = dates.map(d => normalizeDateISO(d)).indexOf(cur);

    let nextIdx;
    if (idx === -1) {
      // If current not found, get first date greater than current
      nextIdx = dates.findIndex(d => new Date(d) > new Date(cur));
    } else {
      nextIdx = idx + 1;
    }

    if (nextIdx === -1 || nextIdx >= dates.length) {
      alert("No next page available.");
      return;
    }

    const nextDate = dates[nextIdx];
    currentSelectedDate = nextDate;
    updateNavbarDate(nextDate);
    await loadTasksForDate(nextDate);

  } catch (err) {
    console.error('goToNextPage error:', err);
    alert('Failed to go to next page.');
  }
}

// Go to the previous page
async function goToPreviousPage() {
  try {
    const pages = await getAllDiaryPages();
    const dates = [...new Set(pages.map(p => normalizeDateISO(p.pageDate)))]
      .filter(Boolean)
      .sort((a, b) => new Date(a) - new Date(b));

    console.log('pages (sorted):', dates);

    const cur = normalizeDateISO(currentSelectedDate || formatDateAsYMD(new Date()));
    const idx = dates.map(d => normalizeDateISO(d)).indexOf(cur);

    let prevIdx;
    if (idx === -1) {
      // If current not found, get last date smaller than current
      prevIdx = dates.map(d => new Date(d)).findIndex(dt => dt >= new Date(cur)) - 1;
    } else {
      prevIdx = idx - 1;
    }

    if (prevIdx < 0) {
      alert("No previous page available.");
      return;
    }

    const prevDate = dates[prevIdx];
    currentSelectedDate = prevDate;
    updateNavbarDate(prevDate);
    await loadTasksForDate(prevDate);

  } catch (err) {
    console.error('goToPreviousPage error:', err);
    alert('Failed to go to previous page.');
  }
}


// ---------- Init & event listeners ----------
document.addEventListener("DOMContentLoaded", async function () {
  renderCalendar(currentDate);
  updateNavbarDate(currentSelectedDate);

  // wire next/prev buttons (ensure these elements exist)
  const nextBtn = document.getElementById("nextPageBtn");
  const prevBtn = document.getElementById("prevPageBtn");
  if (nextBtn) nextBtn.addEventListener("click", goToNextPage);
  if (prevBtn) prevBtn.addEventListener("click", goToPreviousPage);

  const todayStr = formatDateAsYMD(new Date());
  const pages = await getAllDiaryPages();
  const dates = [...new Set(pages.map(p => normalizeDateISO(p.pageDate)))].filter(Boolean).sort((a, b) => new Date(b) - new Date(a));
  const todayExists = dates.includes(todayStr);

  if (todayExists) {
    currentSelectedDate = todayStr;
    updateNavbarDate(todayStr);
    await loadTasksForDate(todayStr);
  } else if (dates.length > 0) {
    currentSelectedDate = dates[0];
    updateNavbarDate(dates[0]);
    await loadTasksForDate(dates[0]);
  }

  // calendar click -> check/create/open page
  document.addEventListener("click", async function (e) {
    const pages = await getAllDiaryPages();
  console.log("All diary pages from DB:", pages.map(p => p.pageDate));
    if (e.target.classList.contains("calendar-day") && e.target.dataset.date) {
    const dateStr = normalizeDateISO(e.target.dataset.date); // force normalized
      const normalized = normalizeDateISO(dateStr);
          currentSelectedDate = dateStr;

      // update UI + track selected date
      // updateNavbarDate(normalized);
      // currentSelectedDate = normalized;

      const exists = await checkPageExists(normalized);
      if (exists) {
        if (confirm(`Page exists for ${normalized}. Open it?`)) {
          await loadTasksForDate(normalized);
                  updateNavbarDate(dateStr); // ‚úÖ Navbar date ab tab change hogi jab page open hoga

        }
      } else {
        if (confirm(`No page found for ${normalized}. Create one?`)) {
          const created = await createPageByDate(normalized);
          if (created) {
            // createPageByDate already sets currentSelectedDate and loads tasks
          }
        }
      }
    }
  });

  // import modal wiring, drag/drop wiring, logo listener, etc. (keep your existing handlers)
  document.getElementById('ediary-logo-link')?.addEventListener('click', function (event) {
    event.preventDefault();
    showDashboard();
  });

  const importBtn = document.getElementById('openImportModalBtn');
  const importModalEl = document.getElementById('importModal');
  if (importBtn && importModalEl) {
    const importModal = new bootstrap.Modal(importModalEl);
    importBtn.addEventListener('click', () => importModal.show());
    importModalEl.addEventListener('hidden.bs.modal', () => {
      document.body.classList.remove('modal-open');
      const backdrop = document.querySelector('.modal-backdrop');
      if (backdrop) backdrop.remove();
    });

    document.getElementById('confirmImportBtn')?.addEventListener('click', async () => {
      const sourceDate = document.getElementById('importDate').value;
      if (!sourceDate) return alert("Select a date to import from.");
      const targetDate = currentSelectedDate ? `${currentSelectedDate}T00:00:00` : `${formatDateAsYMD(new Date())}T00:00:00`;
      try {
        const res = await fetch(`${API_BASE_URL}/api/Pages/copy-tasks`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sourcePageDate: normalizeDateISO(sourceDate) + "T00:00:00",
            targetPageDate: targetDate
          })
        });
        if (!res.ok) throw new Error("Import failed");
        if (importModal) importModal.hide();
        await loadTasksForDate(targetDate.slice(0,10));
        alert("Tasks imported successfully!");
      } catch (err) {
        console.error("Import error:", err);
        alert("Failed to import tasks.");
      }
    });
  }

  // enable drag/drop on kanban columns
  document.querySelectorAll('.kanban-content').forEach(col => {
    col.addEventListener('dragover', handleDragOver);
    col.addEventListener('drop', handleDrop);
  });

  // initial load: try to open today's page automatically (optional)
  // await loadTasksForDate(currentSelectedDate);
});
let allTasksCache = []; // store all tasks once

// Fetch all tasks from API and cache
async function fetchAllTasksForSearch() {
  try {
    const res = await fetch(`${API_BASE_URL}/api/Tasks/allpagetasks`);
    if (!res.ok) throw new Error(`Failed to fetch: ${res.status}`);
    const data = await res.json();
    allTasksCache = Array.isArray(data) ? data : [];
    console.log("All tasks fetched for search:", allTasksCache.length);
  } catch (err) {
    console.error("Error fetching all tasks:", err);
  }
}

// Filter tasks based on query
function filterTasksForSearch(query) {
  query = query.toLowerCase();
  return allTasksCache.filter(task =>
    (task.title && task.title.toLowerCase().includes(query)) ||
    (task.status && task.status.toLowerCase().includes(query))
  );
}

// Render search results in dropdown
function showSearchResults(results) {
  const resultsContainer = document.getElementById("search-results");
  resultsContainer.innerHTML = "";

  if (results.length === 0) {
    resultsContainer.innerHTML = `<div style="padding:5px; font-size:0.9rem;">No results found</div>`;
    return;
  }

  results.forEach(task => {
    const div = document.createElement("div");
    div.style.padding = "6px 10px";
    div.style.cursor = "pointer";
    div.style.borderBottom = "1px solid #f0f0f0";
    div.innerHTML = `<strong>${task.title}</strong><br>
                     <small>${normalizeDateISO(task.pageDate)} - ${task.status}</small>`;

    // Click -> open that page & load its tasks
    div.addEventListener("click", async () => {
      const pageDate = normalizeDateISO(task.pageDate);
      currentSelectedDate = pageDate;
      updateNavbarDate(pageDate);
      await loadTasksForDate(pageDate);
      resultsContainer.innerHTML = ""; // hide dropdown after click
      document.getElementById("global-search").value = "";
    });

    resultsContainer.appendChild(div);
  });
}

// Event listener for typing in search
document.getElementById("global-search")?.addEventListener("input", (e) => {
  const query = e.target.value.trim();
  if (query.length < 2) {
    document.getElementById("search-results").innerHTML = "";
    return;
  }
  const results = filterTasksForSearch(query);

  showSearchResults(results);
});

// Close dropdown if clicked outside
document.addEventListener("click", (e) => {
  if (!document.getElementById("search-results").contains(e.target) &&
      e.target.id !== "global-search") {
    document.getElementById("search-results").innerHTML = "";
  }
});

// Fetch tasks once at page load
document.addEventListener("DOMContentLoaded", fetchAllTasksForSearch);

  function hideFilteredTasks() {
    document.getElementById('filtered-tasks-container').style.display = 'none';
    // Show all diary cards again
    document.querySelectorAll('.diary-card').forEach(card => {
      card.style.display = 'block';
    });
  }

  function filterTasks(tasksToShow, filterStatus) {
    const today = new Date();
    const todayDateOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  
    const mostRecentPastOrToday = {};
    const futureTasks = [];
  
    for (const task of tasksToShow) {
      const pageDate = task.pageDate ? new Date(task.pageDate) : null;
      if (!pageDate) continue;
  
      const pageDateOnly = new Date(pageDate.getFullYear(), pageDate.getMonth(), pageDate.getDate());
      const key = task.parentTaskId ?? task.id;
  
      if (pageDateOnly > todayDateOnly) {
        futureTasks.push(task);
      } else {
        const existing = mostRecentPastOrToday[key];
        if (!existing || pageDate > new Date(existing.pageDate)) {
          mostRecentPastOrToday[key] = task;
        }
      }
    }
  
    const filteredTasksForTab = [
      ...Object.values(mostRecentPastOrToday).filter(task => task.status === filterStatus),
      ...futureTasks.filter(task => task.status === filterStatus)
    ].sort((a, b) => new Date(b.parentTaskCreatedAt) - new Date(a.parentTaskCreatedAt));
  
    if (filteredTasksForTab.length === 0) {
      return {
        empty: true,
        message: `No tasks in "${filterStatus}" status.`,
      };
    }
  
    return {
      empty: false,
      tasks: filteredTasksForTab
    };
  }
  


  async function filterAndRenderByStatus(status) {
  try {
    const res = await fetch(`${API_BASE_URL}/api/Tasks/allpagetasks`);
    const allTasks = await res.json();

    const result = filterTasks(allTasks, status);

    // Clear all columns first
    document.querySelectorAll('.kanban-content').forEach(col => col.innerHTML = '');

    if (result.empty) {
      alert(result.message);
    } else {
      renderFilteredTasks(result.tasks);
    }

  } catch (err) {
    console.error("Filtering failed:", err);
    alert("Unable to filter tasks.");
  }
}
// ‚úÖ Set the active nav link (highlight it)
function setActiveNav(clickedLink) {
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });
  clickedLink.classList.add('active');
}

// ‚úÖ Shared handler for filtering
function showFilteredTasks(status, label) {
  const clickedLink = window.event?.target?.closest('.nav-link');
  if (clickedLink) setActiveNav(clickedLink);

  // Show filtered container
  const container = document.getElementById('filtered-tasks-container');
  const title = document.getElementById('filtered-tasks-title');
  const list = document.getElementById('filtered-tasks-list');

  container.style.display = 'block';
  title.textContent = label + ' Tasks';
  list.innerHTML = '';

  // Hide the main diary content
  document.querySelectorAll('.diary-card').forEach(card => {
    card.style.display = 'none';
  });

  // Run filtering
  filterAndRenderByStatus(status);
}

// ‚úÖ Individual functions ‚Äî no `event` needed
function showInProgressTasks() {
  showFilteredTasks("In Progress", "In Progress");
}

function showNeedToDiscussTasks() {
  showFilteredTasks("To Discuss", "Need To Discuss");
}

function showFollowUpTasks() {
  showFilteredTasks("Follow-Up", "Follow Up");
}

function showOnHoldTasks() {
  showFilteredTasks("On Hold", "On Hold");
}

function showDoneTasks() {
  showFilteredTasks("Completed", "Completed");
}

function showAllTasks() {
  const clickedLink = window.event?.target?.closest('.nav-link');
  if (clickedLink) setActiveNav(clickedLink);

  // Hide main diary card
  document.querySelectorAll('.diary-card').forEach(card => {
    card.style.display = 'none';
  });

  // Show filtered container
  const container = document.getElementById('filtered-tasks-container');
  const title = document.getElementById('filtered-tasks-title');
  const list = document.getElementById('filtered-tasks-list');

  container.style.display = 'block';
  title.textContent = 'All Tasks';
  list.innerHTML = '';

  // Fetch all tasks and render
  fetch(`${API_BASE_URL}/api/Tasks/allpagetasks`)
    .then(res => res.json())
    .then(allTasks => {
      if (!allTasks.length) {
        list.innerHTML = `<div>No tasks found.</div>`;
        return;
      }
      renderFilteredTasks(allTasks);
    })
    .catch(err => {
      console.error("Failed to load all tasks:", err);
      alert("Unable to load all tasks.");
    });
}
// Press Enter to Add Task
document.addEventListener('keydown', function (e) {
  if (e.key === 'Enter' && e.target.classList.contains('diary-task-input')) {
    e.preventDefault();

    // Agar input khali hai to alert dikhao
    if (e.target.value.trim() === '') {
      alert('Please add a task first');
      return;
    }

    // Input ke saath wala "Add Task" button dhoondo
    const container = e.target.closest('.add-task-container');
    const addBtn = container?.querySelector('.add-task-btn');
    if (addBtn) {
      addNewTask(addBtn); // wahi function call jo button click me hai
    }
  }
});



      // Voice-to-Text Integration
      window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (window.SpeechRecognition) {
        const recognition = new window.SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        document.addEventListener('click', function (e) {
          if (e.target.closest('.voice-btn')) {
            const container = e.target.closest('.add-task-card, .diary-card');
            const input = container.querySelector('.diary-task-input');
            const status = container.querySelector('.voice-status');
            recognition.start();
            status.style.display = 'block';
            status.textContent = 'üé§ Listening...';
            recognition.onresult = (event) => {
              const transcript = event.results[0][0].transcript;
              input.value = transcript;
              status.textContent = '‚úÖ Captured: "' + transcript + '"';
              setTimeout(() => status.style.display = 'none', 3000);
            };
            recognition.onerror = (event) => {
              let msg = '‚ùå Voice error: ' + event.error;
              if (event.error === 'no-speech') msg = '‚ö†Ô∏è No speech detected.';
              if (event.error === 'not-allowed') msg = 'üîí Mic access denied.';
              status.textContent = msg;
              setTimeout(() => status.style.display = 'none', 3000);
            };
            recognition.onend = () => {
              setTimeout(() => status.style.display = 'none', 2000);
            };
          }
        });
      } else {
        alert('‚ùå Your browser does not support voice recognition. Please use Chrome or Edge.');
        document.querySelectorAll('.voice-btn').forEach(btn => btn.style.display = 'none');
      }
      async function goToToday() {
  try {
    const today = new Date();
    const todayStr = formatDateAsYMD(today); // e.g. "2025-08-08"

    const exists = await checkPageExists(todayStr);
    if (exists) {
      currentSelectedDate = todayStr;
      updateNavbarDate(todayStr);
      await loadTasksForDate(todayStr);
    } else {
      if (confirm(`No page found for today (${todayStr}). Create one?`)) {
        const created = await createPageByDate(todayStr);
        if (created) {
          // createPageByDate already updates navbar + loads tasks
        }
      }
    }
  } catch (err) {
    console.error("goToToday error:", err);
    alert("Failed to navigate to today's page.");
  }
}
function showDashboard() {
  // Hide filtered tasks section
  const filteredContainer = document.getElementById('filtered-tasks-container');
  if (filteredContainer) {
    filteredContainer.style.display = 'none';
  }

  // Show all diary cards again
  document.querySelectorAll('.diary-card').forEach(card => {
    card.style.display = 'block';
  });

  // Remove active highlight from nav links
  document.querySelectorAll('.nav-link').forEach(link => {
    link.classList.remove('active');
  });
}

// Event listener for logo click
document.getElementById('ediary-logo-link')?.addEventListener('click', function (event) {
  event.preventDefault(); // stop normal link behavior
  showDashboard();
});

async function viewTaskHistory(parentTaskId) {
  try {
    const res = await fetch(`${API_BASE_URL}/api/Tasks/task-history/by-parent/${parentTaskId}`);
    if (!res.ok) throw new Error("Failed to fetch task history");

    const history = await res.json();
    if (!history.length) {
      alert("No history found for this task.");
      return;
    }

    // Parent task created date
    const createdDate = new Date(history[0].parentTaskCreatedAt).toLocaleString();

    // ‚úÖ Only declare msg once
    let msg = `üóì Parent Task Created On: ${createdDate}\n\nüìú Task History:\n\n`;
    history.forEach(h => {
      msg += `‚Ä¢ ${h.title} ‚Äî ${h.status} ‚Äî ${new Date(h.pageDate).toLocaleDateString()}\n`;
    });

    alert(msg);
  } catch (err) {
    console.error("Error fetching history:", err);
    alert("Unable to load task history.");
  }
}
const modal = document.getElementById("notes-modal");
const textarea = document.getElementById("note-content");

// Open Modal + Load Note
document.getElementById("notes-btn").addEventListener("click", async () => {
    const diaryId = 1; // fixed for now
    try {
        let response = await fetch(`http://192.168.137.1:5158/api/diaries/${diaryId}/note`);
        if (response.ok) {
            let note = await response.json();
            textarea.value = note.description;
        } else {
            textarea.value = ""; // No note found
        }
        modal.style.display = "block";
    } catch (err) {
        console.error("Error fetching note:", err);
        alert("Failed to load note.");
    }
});

// Save Note (PUT) + Close Popup
document.getElementById("save-note").addEventListener("click", async () => {
    const diaryId = 1;
    try {
        let response = await fetch(`http://192.168.137.1:5158/api/diaries/${diaryId}/note`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ description: textarea.value })
        });

        if (response.ok) {
            alert("Note saved successfully!");
            modal.style.display = "none"; // ‚úÖ close popup after save
        } else {
            alert("Error saving note.");
        }
    } catch (err) {
        console.error("Error saving note:", err);
    }
});

// Close Modal (manual)
document.getElementById("close-note").addEventListener("click", () => {
    modal.style.display = "none";
});
document.getElementById("export-pdf-btn").addEventListener("click", () => {
  const { jsPDF } = window.jspdf;

  // ‚úÖ Grab current diary date for title
  const dateTitle = document.getElementById("diary-date-title")?.textContent.trim() || "Diary Page";

  // ‚úÖ Define statuses and their container IDs
  const statusMap = {
    "TO-DO": "todo-column",
    "IN PROGRESS": "inprogress-column",
    "TO DISCUSS": "todiscuss-column",
    "FOLLOW-UP": "followup-column",
    "ON HOLD": "onhold-column",
    "COMPLETED": "completed-column"
  };

  // ‚úÖ Collect tasks grouped by status
  let tasksByStatus = {};
  Object.entries(statusMap).forEach(([status, colId]) => {
    const col = document.getElementById(colId);
    const tasks = col ? [...col.querySelectorAll(".task-title")].map(el => el.textContent.trim()) : [];
    tasksByStatus[status] = tasks;
  });

  // ‚úÖ Build PDF
  const doc = new jsPDF();
  let y = 20;

  // Title
  doc.setFont("helvetica", "bold");
  doc.setFontSize(14);
  doc.setTextColor(0, 0, 0); // black for title
  doc.text(`Tasks for ${dateTitle}`, 14, y);
  y += 10;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(12);

  Object.entries(tasksByStatus).forEach(([status, tasks]) => {
    // üîµ Blue headings
    doc.setTextColor(0, 102, 204);
    doc.setFont("helvetica", "bold");
    doc.text(status, 14, y);
    y += 8;

    // ‚ö´ Black tasks
    doc.setTextColor(0, 0, 0);
    doc.setFont("helvetica", "normal");

    if (tasks.length === 0) {
      doc.text("‚Äî No tasks ‚Äî", 20, y);
      y += 8;
    } else {
      tasks.forEach((task, i) => {
        if (y > 280) { // add new page if space is low
          doc.addPage();
          y = 20;
        }
        doc.text(`${i + 1}. ${task}`, 20, y);
        y += 8;
      });
    }

    y += 6; // space between sections
  });

  // ‚úÖ Save with filename based on date
  const safeDate = dateTitle.replace(/[\s,]/g, "_");
  doc.save(`diary_tasks_${safeDate}.pdf`);
});

</script>

</body>

</html>